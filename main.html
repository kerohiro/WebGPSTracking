<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS Logger</title>
</head>
<body>
  <h1>GPS Logger</h1>
  <button onclick="startLogging()">Start Logging</button>
  <button onclick="stopLogging()">Stop Logging</button>
  <button onclick="downloadCSV()">Log File Download</button>
  <p id="status">Preparing...</p>

  <script>
    let logs = [];
    let gpsInterval = null;

    // sensor value
    let sensorData = {ax: null, ay: null, az: null, alpha:null, beta:null, gamma:null};

    // get permission for DeviceMotion / DeviceOrientation
    async function requestSensorPermission() {
        if (typeof DeviceMotionEvent.requestPermission === "function") {
            const motionPerm = await DeviceMotionEvent.requestPermission();
            if(motionPerm !== "granted") return false;
            const orientationPerm = await DeviceOrientationEvent.requestPermission();
            if(orientationPerm !== "granted") return false;
        }
        return true;
    }

    // setup sensor event
    function setupSensors() {
        window.addEventListener("devicemotion", (e) => {
            sensorData.ax = e.acceleration.x;
            sensorData.ay = e.acceleration.y;
            sensorData.az = e.acceleration.z;
        });
        window.addEventListener("deviceorientation",(e) => {
            sensorData.alpha = e.alpha;
            sensorData.beta = e.beta;
            sensorData.gamma = e.gamma;
        });
    }

    // Logging
    function startLogging() {
      document.getElementById("status").innerText = "Logging...";
      
      const perm = await requestSensorPermission();
      if(!perm){
        alert("Permission denied");
        return;
      }
      setupSensors();

      if (!navigator.geolocation) {
        alert("geolocation are not available");
        return;
      }

      gpsInterval = setInterval(() => {
        nabigator.geolocation.getCurrentPosition((pos) => {
            if(pos && pos.coords){
                const data = {
                    lat: pos.coords.latitude || 0,
                    lon: pos.coords.longitude || 0,
                    accuracy: pos.coords.accuracy || null,
                    time: new Date().toISOString(),
                    ax: sensorData.ax,
                    ay: sensorData.ay,
                    az: sensorData.az,
                    alpha : sensorData.alpha,
                    beta : sensorData.beta,
                    gamma : sensorData.gamma
                };
                logs.push(data);
                console.log(data);
            }
            }, (err) => console.error("GPS error",err),
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 10000
            });
        },10000);
    }

    // ログ停止
    function stopLogging() {
      if (gpsInterval) {
        clearInterval(gpsInterval);
        gpsInterval = null;
        document.getElementById("status").innerText = "Stop logging";
      }
    }

    // Log download in csv format
    function downloadCSV() {
      if (logs.length === 0) {
        alert("No records");
        return;
      }

      let csv = "lat,lon,accuracy,time\n";
      logs.forEach(d => {
        csv += `${d.lat},${d.lon},${d.accuracy},${d.time}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gps_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
