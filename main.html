<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS Logger</title>
</head>
<body>
  <h1>GPS Logger</h1>
  <button onclick="startLogging()">Start Logging</button>
  <button onclick="stopLogging()">Stop Logging</button>
  <button onclick="downloadCSV()">Log File Download</button>
  <p id="status">Preparing...</p>

  <script>
    let watchId = null;
    let logs = [];

    // ログ開始
    function startLogging() {
      document.getElementById("status").innerText = "Logging...";
      if (!navigator.geolocation) {
        alert("not available in this device");
        return;
      }

      // 10秒おきに現在地取得
      watchId = setInterval(() => {
        navigator.geolocation.getCurrentPosition((pos) => {
          const data = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            time: new Date().toISOString()
          };
          logs.push(data);
          console.log("記録:", data);
        }, (err) => {
          console.error(err);
        });
      }, 10000);
    }

    // ログ停止
    function stopLogging() {
      if (watchId) {
        clearInterval(watchId);
        watchId = null;
        document.getElementById("status").innerText = "Stop logging";
      }
    }

    // CSVダウンロード
    function downloadCSV() {
      if (logs.length === 0) {
        alert("No records");
        return;
      }

      let csv = "lat,lon,accuracy,time\n";
      logs.forEach(d => {
        csv += `${d.lat},${d.lon},${d.accuracy},${d.time}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gps_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
